name: Build and Release

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-15
    permissions:
      contents: write  # Required for creating releases
    steps:
      - uses: actions/checkout@v4

      - name: Install xcodegen
        run: |
          brew install xcodegen
          xcodegen --version

      - name: Generate Xcode Project
        run: xcodegen generate

      - name: Build
        run: |
          xcodebuild -project AudioToggle.xcodeproj \
            -scheme AudioToggle \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO

      - name: Create App Bundle
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          APP_PATH="build/Build/Products/Release/AudioToggle.app"
          if [ -d "$APP_PATH" ]; then
            echo "App bundle found at $APP_PATH"
          else
            echo "Error: App bundle not found"
            exit 1
          fi

      - name: Install create-dmg
        if: startsWith(github.ref, 'refs/tags/')
        run: brew install create-dmg

      - name: Create DMG
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          create-dmg \
            --volname "AudioToggle" \
            --volicon "build/Build/Products/Release/AudioToggle.app/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 400 300 \
            --icon-size 100 \
            --icon "AudioToggle.app" 100 120 \
            --app-drop-link 280 120 \
            "AudioToggle-${VERSION}.dmg" \
            "build/Build/Products/Release/AudioToggle.app" || true

          # Fallback to simple DMG if create-dmg fails
          if [ ! -f "AudioToggle-${VERSION}.dmg" ]; then
            hdiutil create -volname "AudioToggle" \
              -srcfolder "build/Build/Products/Release/AudioToggle.app" \
              -ov -format UDZO \
              "AudioToggle-${VERSION}.dmg"
          fi

      - name: Upload Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: AudioToggle-*.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifact
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: AudioToggle-app
          path: build/Build/Products/Release/AudioToggle.app
          retention-days: 7
